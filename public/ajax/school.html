<div class="row">
	<div class="col-xs-12 col-sm-12 col-md-12 col-lg-12">
		<h1 class="page-title txt-color-blueDark">
			<i class="fa fa-graduation-cap fa-fw "></i> 院校信息
		</h1>
	</div>
</div>

<!-- widget grid -->
<section id="widget-grid" class="">

	<!-- row -->
	<div class="row">

		<!-- NEW WIDGET START -->
		<article class="col-xs-12 col-sm-12 col-md-12 col-lg-12">

			<!-- Widget ID (each widget will need unique ID)-->
			<div class="jarviswidget" id="wid-id-0"
				data-widget-deletebutton="false" data-widget-editbutton="false">
				<!-- widget options:
					usage: <div class="jarviswidget" id="wid-id-0" data-widget-editbutton="false">
					
					data-widget-colorbutton="false"	
					data-widget-editbutton="false"
					data-widget-togglebutton="false"
					data-widget-deletebutton="false"
					data-widget-fullscreenbutton="false"
					data-widget-custombutton="false"
					data-widget-collapsed="true" 
					data-widget-sortable="false"
					
				-->
				<header>
					<span class="widget-icon"> <i class="fa fa-edit"></i>
					</span>
					<h2>查询</h2>

				</header>

				<!-- widget div-->
				<div>

					<!-- widget content -->
					<div class="widget-body">
						<form id="school-query-form" class="smart-form">
							<fieldset>
								<div class="row">
									<section class="col col-4  col-sm-6">
										<label class="select">
												<select id="year">
											 		<option value="2013">2013</option>
													<option value="2012">2012</option>
													<option value="2011">2011</option>
												</select>
												<i></i>
										</label>
									</section>
									<section class="col col-4  col-sm-6">
										<label class="input"> 
<!-- 											<i class="icon-prepend fa fa-graduation-cap"></i> -->
											<input type="text"
												id="school_name" placeholder="院校名称" >
										</label>
									</section>
									<section class="col col-4  col-sm-6">
										<label class="select"> <select id="region_name">
												<option value="">所在地</option>
											  	<option value="北京">北京</option>
											  	<option value="甘肃">甘肃</option>
											  	<option value="河北">河北</option>
											  	<option value="黑龙江">黑龙江</option>
											  	<option value="湖北">湖北</option>
											  	<option value="吉林">吉林</option>
											  	<option value="江苏">江苏</option>
											  	<option value="江西">江西</option>
											  	<option value="辽宁">辽宁</option>
											  	<option value="内蒙古">内蒙古</option>
											  	<option value="青海">青海</option>
											  	<option value="上海">上海</option>
											  	<option value="天津">天津</option>
											  	<option value="新疆">新疆</option>
										       	<option value="">全部</option>
										    </select> <i></i>
										</label>
									</section>
								</div>
								
								<div class="row">
									
									<section class="col col-4 col-sm-6">
										<label class="select"> <select id="batch_name">
												<option value="">招生批次</option>
											  	<option value="本科第一批">本科第一批</option>
											  	<option value="本科第二批">本科第二批</option>
											  	<option value="本科二批B">本科二批B</option>
											  	<option value="高职高专批">高职高专批</option>
											  	<option value="高职高专3F批">高职高专3F批</option>
										    </select> <i></i>
										</label>
									</section>
									
									<section class="col col-4 col-sm-6">
										<label class="select"> <select id="student_class">
												<option value="">考生类别</option>
											  	<option value="普通文科">普通文科</option>
											  	<option value="普通理科">普通理科</option>
											  	<option value="蒙授文科">蒙授文科</option>
											  	<option value="蒙授理科">蒙授理科</option>
										    </select> <i></i>
										</label>
									</section>

									<section  class="col col-2 col-sm-1">
										<label class="checkbox"> <input type="checkbox"
											name="mark_211" id="mark_211"> <i></i>211院校
										</label> 
									</section>
									<section  class="col col-2 col-sm-1">
										<label class="checkbox"> <input type="checkbox"
											name="mark_985" id="mark_985"> <i></i>985院校</label>
									</section>
									
								</div>
								
								<div class="row">
									<section  class="col col-12 col-sm-12">
										<a id="submit" class="btn btn-primary btn-sm" ><i class="fa fa-search"></i>
											查询
										</a>
									</section>
								</div>
							</fieldset>
						</form>
					</div>
					<!-- end widget content -->

				</div>
				<!-- end widget div -->

			</div>
			<!-- end widget -->
			
			<!-- Widget ID (each widget will need unique ID)-->
			<div class="jarviswidget" id="wid-id-1" data-widget-editbutton="false" data-widget-deletebutton="false" >
				<!-- widget options:
				usage: <div class="jarviswidget" id="wid-id-0" data-widget-editbutton="false">

				data-widget-colorbutton="false"
				data-widget-editbutton="false"
				data-widget-togglebutton="false"
				data-widget-deletebutton="false"
				data-widget-fullscreenbutton="false"
				data-widget-custombutton="false"
				data-widget-collapsed="true"
				data-widget-sortable="false"

				-->
				<header>
					<span class="widget-icon"> <i class="fa fa-table"></i> </span>
					<h2>数据</h2>

				</header>

				<!-- widget div-->
				<div>

					<!-- widget content -->
					<div class="widget-body no-padding">
						<h1 id="loading" class="ajax-loading-animation text-center"><i class="fa fa-cog fa-spin"></i> Loading...</h1>
						<table id="datatable_col_reorder" class="table table-striped table-condensed table-hover" cellspacing="0" width="100%">
							<thead>
								<tr>
									<th class="hidden">id</th>
									<th>院校名称</th>
									<th>排名</th>
									<th>地区</th>
									<th>批次</th>
									<th>学生类别</th>
								</tr>
							</thead>
						</table>

					</div>
					<!-- end widget content -->
							 
				</div>
				<!-- end widget div -->

			</div>
			<!-- end widget -->

		</article>
		<!-- WIDGET END -->

	</div>
	<!-- end row -->
</section>
<!-- end widget grid -->

<script type="text/javascript">
    /* DO NOT REMOVE : GLOBAL FUNCTIONS!
     *
     * pageSetUp(); WILL CALL THE FOLLOWING FUNCTIONS
     *
     * // activate tooltips
     * $("[rel=tooltip]").tooltip();
     *
     * // activate popovers
     * $("[rel=popover]").popover();
     *
     * // activate popovers with hover states
     * $("[rel=popover-hover]").popover({ trigger: "hover" });
     *
     * // activate inline charts
     * runAllCharts();
     *
     * // setup widgets
     * setup_widgets_desktop();
     *
     * // run form elements
     * runAllForms();
     *
     ********************************
     *
     * pageSetUp() is needed whenever you load a page.
     * It initializes and checks for all basic elements of the page
     * and makes rendering easier.
     *
     */
	
    pageSetUp();

    // PAGE RELATED SCRIPTS

    // pagefunction

    var pagefunction = function() {
        var dt = $('#datatable_col_reorder').DataTable({
            "iDisplayLength":20,
            "bPaginate": true,
            "bFilter": false,
            "bSort": true, //排序功能
            "bLengthChange":false,
            "bInfo": false,
            "deferRender": true,
            "renderer": "bootstrap",
            "processing": false,
            "serverSide": true,
            "bDestroy": true,
            "ajax": {
                "url": "/schoolInfo/all",
                "type": "POST",
                "data": function ( d ) {
                    return $.extend( {}, d, {
                        "year": $('#year').val(),
                        "school_name": $('#school_name').val(),
                        "region_name": $('#region_name').val(),
                        "batch_name": $('#batch_name').val(),
                        "student_class": $('#student_class').val(),
                        "mark_211": $("#mark_211").attr("checked") ? 'on' : 'off',
                                "mark_985": $("#mark_985").attr("checked") ? 'on' : 'off'
                      } );
                 },
                 "error": function(request) {
                     $.bigBox({
             			title : "Error",
             			content : "查询院校信息出错，请联系系统管理员！",
             			color : "#C46A69",
             			icon : "fa fa-warning shake animated",
             			timeout : 6000
             		});
                 },
                 "complete": function() {
                     $("#loading").hide();
                     $("#datatable_col_reorder_wrapper").fadeIn(500);
                 },
                 "beforeSend": function() {
                     $("#loading").show();
                     $("#datatable_col_reorder_wrapper").hide();
                 }
            },
			"oLanguage": {
			    "sZeroRecords": "没有检索到数据",
			    "oPaginate": {
			    "sPrevious": "上一页",
			    "sNext": "下一页",
			    },
			  "sZeroRecords": "没有检索到数据",
			},
			"columns": [
	            { "data": "_id" },
	            { "data": "school_name" },
	            { "data": "ranking" },
	            { "data": "region_name" },
	            { "data": "batch_name" },
	            { "data": "student_class" }
			],
		  	"columnDefs": [ {
		  	  "targets": 2,
		  	    "defaultContent": "-"
		  	  }, {
		  	    "targets": 1,
		  	    "render": function ( data, type, full, meta ) {
		  	        var tdHtml = '<strong>'+data+'</strong><br />';
		  	        if (full.mark_211) {
		  	          tdHtml += '<img src="img/school/211.jpg" title="211工程院校" height="30px"></img>';
		  	        }
		  	        if (full.mark_985) {
		  	          tdHtml += '<img src="img/school/985.png" height="30px"></img>';
		  	        }
					return tdHtml;
		  	    },
		  	  	"sortable": true,
		  	  	"sWidth": "30%"
		  	  }, {
	                "targets": [ 0 ],
	                "visible": false
		  	  }, {
	                "targets": [ 3, 4, 5 ],
	                "sortable": false,
	                "sWidth": "20%"
		  	  }],
		  	/* "fnDrawCallback": function (oSettings) {
		  	 	runAllCharts();
             } */
		  	
        });
        
        //定义图表头信息
        var chartsHeader = [
        	'<span>近3年分数趋势图</span>',
        	'<span>近3年招生计划趋势图</span>',
        	'<span>往年招生计划比例图</span>',
        ];
        
        var chartsBody = [
			'<div id="score-graph" class="chart no-padding"><h1 class="ajax-loading-animation text-center"><i class="fa fa-cog fa-spin"></i> Loading...</h1></div>',
			'<div id="plan-graph" class="chart no-padding"><h1 class="ajax-loading-animation text-center"><i class="fa fa-cog fa-spin"></i> Loading...</h1></div>',
			'<div id="bar-graph" class="chart no-padding"><h1 class="ajax-loading-animation text-center"><i class="fa fa-cog fa-spin"></i> Loading...</h1></div>',
        ];
        function format ( d ) {
            //var graphsHtml = '<div class="row"><div class="col-xs-12 col-sm-12 col-md-12 col-lg-4">';
            var graphsHtml = '<div class="row">';
            for (var i = 0; i < 3; i++) {
                graphsHtml += '<div class="col-xs-12 col-sm-12 col-md-4 col-lg-4">';
                //graphsHtml += '<div class="well well-lg well-right">';
                //graphsHtml += '<div class="text-left">';
                graphsHtml += chartsHeader[i]+chartsBody[i];
                //graphsHtml += '</div>';
                //graphsHtml += '</div>';
                graphsHtml += '</div>';
            }
            return graphsHtml+"</div>";
        }
        
        //初始化datatables点击显示图表
        $('#datatable_col_reorder tbody').on( 'click', "tr[role='row']", function () {
            var tr = $(this);
            var row = dt.row(tr);
            dt.rows().eq(0).each(function(idx){
                if (row.index() != idx && dt.row(idx).child.isShown()) {
                    dt.row(idx).child.hide();
                }
            });
            if ( row.child.isShown() ) {
                row.child.hide();
            }
            else {
                row.child( format( row.data() ) ).show();
                //runAllCharts();
             	// area graph
                initGraphs(row.data());
            }
        } );
        
        function initGraphs(d) {
            if ($('#score-graph').length){
                $.ajax({
    		        url:'/schoolInfo/scores',
    		        type:'GET',
    		        data : {
						school_name : d.school_name,
                		batch_name : d.batch_name,
                		student_class : d.student_class
					},
					success : function(datas) {
				        var data_arr = [];
				        var all_score = [];
				        $.each(datas.datas, function(idx, rowData){
				            data_arr.push({
				                period: ""+rowData.year,
				                x: rowData.tidang_score ? rowData.tidang_score : null,
				            	y: rowData.average_score ? rowData.average_score : null,
				            	z: rowData.max_score ? rowData.max_score : null
				            });
				            if (rowData.tidang_score)
				            	all_score.push(rowData.tidang_score);
				            if (rowData.average_score)
				            	all_score.push(rowData.average_score);
				            if (rowData.max_score)
				            	all_score.push(rowData.max_score);
				        });
				        all_score.sort(function sortNumber(a,b){ 
				            return a - b 
				        });
				        var maxScore = all_score[all_score.length - 1];
				        var minScore = all_score[0];
				        Morris.Line({
		      				element: 'score-graph',
		      				data: data_arr,
		      				xkey: 'period',
		      				ykeys: ['z', 'y', 'x'],
		      				labels: ['最高分', '平均分', '最低分'],
		      				ymax:maxScore + (maxScore - minScore) / 2,
		      				ymin:minScore - (maxScore - minScore) / 2
		      				//pointSize: 6,
		    				//xLabels:'year',
		    				//events:['2013','2012','2011']
		      			})
					}
    		    });
    		};
    		
    		if ($('#plan-graph').length){
    		    $.ajax({
    		        url:'/schoolInfo/plans',
    		        type:'GET',
    		        data : {
						school_name : d.school_name,
                		batch_name : d.batch_name,
                		student_class : d.student_class
					},
					success : function(datas) {
				        var data_arr = [];
				        var all_score = [];
				        $.each(datas.datas, function(idx, rowData){
				            data_arr.push({
				                period: ""+rowData.year,
				                x: rowData.apply_num ? rowData.apply_num : null,
				                y: rowData.plan_hire_num ? rowData.plan_hire_num : null,
				            	z: rowData.enrolled_num ? rowData.enrolled_num : null
				            });
				            if (rowData.plan_hire_num)
				            	all_score.push(rowData.plan_hire_num);
				            if (rowData.apply_num)
				            	all_score.push(rowData.apply_num);
				            if (rowData.enrolled_num)
				            	all_score.push(rowData.enrolled_num);
				        });
				        all_score.sort(function sortNumber(a,b){ 
				            return a - b 
				        });
				        var maxScore = all_score[all_score.length - 1];
				        var minScore = all_score[0];
				        Morris.Line({
		      				element: 'plan-graph',
		      				data: data_arr,
		      				xkey: 'period',
		      				ykeys: ['x', 'y', 'z'],
		      				labels: ['考生报考', '计划招生', '实际录取'],
		      				ymax:maxScore + (maxScore - minScore) / 2,
		      				ymin:minScore - (maxScore - minScore) / 2 < 0 ? 0 : minScore - (maxScore - minScore) / 2
		      				//pointSize: 6,
		    				//xLabels:'year',
		    				//events:['2013','2012','2011']
		      			})
					}
    		    });
    		};
    		
    		// donut
    		if ($('#bar-graph').length){
    		    $.ajax({
    		        url:'/schoolInfo/plan',
    		        type:'GET',
    		        data : {
						_id : d._id
					},
					success : function(data) {
				        var data_arr = [
							{ value: data.apply_num ? data.apply_num : null, label: '考生报考人数'},
				            { value: data.plan_hire_num ? data.plan_hire_num : null, label: '计划招生人数'},
		    			    { value: data.enrolled_num ? data.enrolled_num : null, label: '实际录取人数'}
		    			    
				        ];
					    Morris.Donut({
		    			  element: 'bar-graph',
		    			  data: data_arr,
		    			  formatter: function(d) {
		    			      return d+"人";
		    			  }
		    			});
					}
    		    });
    		}
    		
        }
        
     
        // On each draw, loop over the `detailRows` array and show any child rows
       /*  dt.on( 'draw', function () {
            $.each( detailRows, function ( i, id ) {
                $('#'+id+' td:first-child').trigger( 'click' );
            } );
        } ); */
        
        /* COLUMN FILTER  
	    var otable = $('#datatable_col_reorder').DataTable({
	        "bPaginate": true, //翻页功能
	        "bLengthChange": false, //改变每页显示数据数量
	        "bFilter": false, //过滤功能
	        "bSort": true, //排序功能
	        "bInfo": true,//页脚信息
	        "bAutoWidth": true,//自动宽度
	        "aaSorting": [
				[ 1, "asc" ]
			],
			"bProcessing":true,
			"iDeferLoading":true,
			"iDisplayLength":30,
			"sAjaxSource":"datasource.txt"
	    });
        
	    $("div.toolbar").html('<div class="text-right"><img src="img/logo.png" alt="SmartAdmin" style="width: 111px; margin-top: 3px; margin-right: 10px;"></div>');
        */
        //b.html('<h1 class="ajax-loading-animation"><i class="fa fa-cog fa-spin"></i> Loading...</h1>'),
        $("#datatable_col_reorder_wrapper").addClass("table-responsive");
        //$(dt.table().container()).addClass( 'table-responsive' );
        //dt.tables().containers().to$().addClass("table-responsive");
        /* tables
        .tables()
        .containers()
        .to$() */
        //定义查询按钮
        $("#submit").on('click', function(){
            dt.ajax.reload();
        });
        
        $("#school_name").autocomplete({
			source : function(request, response) {
				$.ajax({
					url : "/school/names",
					dataType : "json",
					data : {
						featureClass : "P",
						style : "full",
						maxRows : 14,
						name_startsWith : request.term
					},
					success : function(data) {
					    response($.map(data, function(item) {
							return {
								label : item.name,
								value : item.name
							}
						}));
					}
				});
			},
			minLength : 2,
			select : function(event, ui) {
				$('#school_name').attr('value', ui.item.label);
			}
		});
        
    };
    
    
    
    loadScript("js/plugin/sparkline/jquery.sparkline.min.js", function(){
    	loadScript("js/plugin/datatables/jquery.dataTables.min.js", function(){
			loadScript("js/plugin/datatables/dataTables.colVis.min.js", function(){
				loadScript("js/plugin/datatables/dataTables.tableTools.min.js", function(){
				    loadScript("js/plugin/morris/raphael.min.js", function(){
				    	loadScript("js/plugin/morris/morris.min.js", function(){
							loadScript("js/plugin/datatables/dataTables.bootstrap.min.js", pagefunction);
				    	});
				    });
				});
			});
		});
    });
</script>
