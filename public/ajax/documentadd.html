<div class="row">
	<div class="col-xs-12 col-sm-12 col-md-12 col-lg-12">
		<h1 class="page-title txt-color-blueDark">
			<i class="fa fa-edit fa-fw "></i> 档案录入
		</h1>
	</div>
</div>

<!-- widget grid -->
<section id="widget-grid" class="">

	<!-- row -->
	<div class="row">

		<!-- NEW WIDGET START -->
		<article class="col-xs-12 col-sm-12 col-md-12 col-lg-12">

			<!-- Widget ID (each widget will need unique ID)-->
			<div class="jarviswidget" id="wid-id-0"
				data-widget-deletebutton="false" data-widget-editbutton="false">
				<!-- widget options:
					usage: <div class="jarviswidget" id="wid-id-0" data-widget-editbutton="false">
					
					data-widget-colorbutton="false"	
					data-widget-editbutton="false"
					data-widget-togglebutton="false"
					data-widget-deletebutton="false"
					data-widget-fullscreenbutton="false"
					data-widget-custombutton="false"
					data-widget-collapsed="true" 
					data-widget-sortable="false"
					
				-->
				<header>
					<span class="widget-icon"> <i class="fa fa-edit"></i>
					</span>
					<h2>录入</h2>

				</header>

				<!-- widget div-->
				<div>

					<!-- widget content -->
					<div class="widget-body">
					<div id="tdDetail" class="row">
							<div class="page foldtl col-lg-8 col-md-12 col-lg-offset-2">
								<div class="media">
									<p class="media-heading font-lg text-center "><strong></strong></p>
									<div class="col-lg-8 col-md-8">
										<div id="media_body" class="media-body" >
											<dl class="dl-horizontal">
									        <dt style="padding-top:5px">档案编号</dt>
									        <dd style="padding-top:5px"></dd>
									        <dt style="padding-top:5px">项目名称</dt>
									        <dd style="padding-top:5px"></dd>
									        <dt style="padding-top:5px">档案类型</dt>
									        <dd style="padding-top:5px"></dd>
									        <dt style="padding-top:5px">档案录入员</dt>
									        <dd style="padding-top:5px"></dd>
									        <dt style="padding-top:5px">档案位置</dt>
									        <dd style="padding-top:5px"></dd>
									        <dt style="padding-top:5px">档案总数</dt>
									        <dd style="padding-top:5px"></dd>
									        <dt style="padding-top:5px">主题词</dt>
									        <dd style="padding-top:5px"></dd>
									        <dt style="padding-top:5px">电子档案</dt>
									        <dd style="padding-top:5px"><a href=""></a></dd>
									      </dl> 	 
										</div>
									</div>
									<div class="col-lg-4 col-md-4">
										<img id="doc_img_preview" class="media-object pull-right col-lg-12 col-md-12" alt="无封面" >
									</div>
								</div>
							</div>
						</div>
						<form id="docadd-form" action="" class="smart-form">
							<fieldset>
							<div class="row">
								<section class="col col-4  col-sm-6">
									<label class="input"> 
										<i class="icon-prepend fa fa-folder"></i>
										<input type="text"
											name="doc_name" placeholder="档案名称">
										<input type="hidden" id="doc_img" name="doc_img" value="">
										<input type="hidden" id="doc_file" name="doc_file" value="">
									</label>
								</section>
								<section class="col col-4  col-sm-6">
									<label class="input"> 
										<i class="icon-prepend fa fa-folder"></i>
										<input type="text"
											name="project_name" placeholder="项目名称">
									</label>
								</section>
								<section class="col col-4  col-sm-6">
									<label class="select"> <select name="doc_type">
											<option value="">档案类型</option>
										  	<option value="控规">控规</option>
										  	<option value="详规">详规</option> 
									    </select> <i></i>
									</label>
								</section>
								</div>
								<div class="row">
								<section class="col col-4 col-sm-6">
									<label class="select"> <select name=doc_mgr>
											<option value="">档案管理员</option>
										  	<option value="管理员1">管理员1</option>
										  	<option value="管理员2">管理员2</option> 
									    </select> <i></i>
									</label>
								</section>
								<section class="col col-4 col-sm-6">
									<label class="select"> <select name="doc_location">
											<option value="">档案位置</option>
										  	<option value="西1柜">西1柜</option>
										  	<option value="北1柜">北1柜</option> 
									    </select> <i></i>
									</label>
								</section>
								<section class="col col-4 col-sm-6">
									<label class="input"> 
										<i class="icon-prepend fa fa-database"></i>
										<input type="text"
											name="total_num" placeholder="库存数量">
									</label>
								</section>
								</div>
								<div class="row">
									<section class="col col-4 col-sm-6">
										<label class="input"> 
											<i class="icon-prepend fa fa-database"></i>
											<input type="text"
												name="doc_tag" placeholder="主题词">
										</label>
									</section>
								</div>
							</fieldset>
							<fieldset>
								<span class="btn btn-sm btn-primary fileinput-button dz-clickable">
						            <i class="glyphicon glyphicon-plus"></i>
						            <span>添加档案封面</span>
						        </span>
								<div class="table table-striped" class="files" id="previews" >
								  <div id="template" class="">
								    <div style="margin-top:20px;">
								        <span class="preview"><img data-dz-thumbnail /></span>
								    </div>
								     <div>
										<p class="name" data-dz-name></p>
										<strong class="error text-danger" data-dz-errormessage></strong>
									</div>
								    <div style="margin-top:5px;">
								        <div class="progress progress-striped active" role="progressbar" aria-valuemin="0" aria-valuemax="100" aria-valuenow="0">
								          <div class="progress-bar progress-bar-success" style="width:0%;" data-dz-uploadprogress></div>
								        </div>
								    </div>
								    <div>
								      <span data-dz-upload class="btn btn-primary btn-sm start"> <i class="glyphicon glyphicon-upload"></i>上传</span>
								      <!-- <a data-dz-remove class="btn btn-warning btn-sm cancel disabled">
								        <i class="glyphicon glyphicon-stop"></i>
								        <span>停止</span>
								      </a> -->
								      <a data-dz-remove class="btn btn-danger btn-sm delete">
								        <i class="glyphicon glyphicon-trash"></i>
								        <span>删除</span>
								      </a>
								    </div>
								  </div>
								</div>
							</fieldset>
							<fieldset>
								<span class="btn btn-sm btn-primary docfileinput-button dz-clickable">
						            <i class="glyphicon glyphicon-plus"></i>
						            <span>添加电子档案</span>
						        </span>
								<div class="table table-striped" class="files" id="docpreviews" >
								  <div id="doctemplate" class="">
								    <div style="margin-top:20px;">
								        <span class="preview"><img data-dz-thumbnail /></span>
								    </div>
								     <div>
										<p class="name" data-dz-name></p>
										<strong class="error text-danger" data-dz-errormessage></strong>
									</div>
								    <div style="margin-top:5px;">
								        <div class="progress progress-striped active" role="progressbar" aria-valuemin="0" aria-valuemax="100" aria-valuenow="0">
								          <div class="progress-bar progress-bar-success" style="width:0%;" data-dz-uploadprogress></div>
								        </div>
								    </div>
								    <div>
								      <span data-dz-upload class="btn btn-primary btn-sm start"> <i class="glyphicon glyphicon-upload"></i>上传</span>
								      <!-- <a data-dz-remove class="btn btn-warning btn-sm cancel disabled">
								        <i class="glyphicon glyphicon-stop"></i>
								        <span>停止</span>
								      </a> -->
								      <a data-dz-remove class="btn btn-danger btn-sm delete">
								        <i class="glyphicon glyphicon-trash"></i>
								        <span>删除</span>
								      </a>
								    </div>
								  </div>
								</div>
							</fieldset>
							<footer>
								<button id="submit-form" type="submit" class="btn btn-primary">
								<i class="fa fa-save"></i>
									提交
								</button>
							</footer>
						</form>
						
					</div>
					<!-- end widget content -->

				</div>
				<!-- end widget div -->

			</div>
			<!-- end widget -->
			
		</article>
		<!-- WIDGET END -->

	</div>
	<!-- end row -->
</section>
<!-- end widget grid -->

<script type="text/javascript">

    pageSetUp();

    var pagefunction = function() {
        function initEcard(d, e) {
            if (d.doc_img)
                $('#doc_img_preview').attr('src', d.doc_img);
            else
                $('#doc_img_preview').attr('src', ' ');
            if (d.doc_name)
                $('.media-heading').text(d.doc_name);
            else
                $('.media-heading').text(' ');
            if (d.doc_id)
                $('#media_body dd').eq(0).text(d.doc_id);
            else
                $('#media_body dd').eq(0).text(' ');
            if (d.project_name)
                $('#media_body dd').eq(1).text(d.project_name);
            else
                $('#media_body dd').eq(1).text(' ');
            if (d.doc_type)
                $('#media_body dd').eq(2).text(d.doc_type);
            else
                $('#media_body dd').eq(2).text(' ');
            if (d.doc_mgr)
                $('#media_body dd').eq(3).text(d.doc_mgr);
            else
                $('#media_body dd').eq(3).text(' ');
            if (d.doc_location)
                $('#media_body dd').eq(4).text(d.doc_location);
            else
                $('#media_body dd').eq(4).text(' ');
            if (d.total_num)
                $('#media_body dd').eq(5).text(d.total_num);
            else
                $('#media_body dd').eq(5).text(' ');
            if (d.doc_tag)
                $('#media_body dd').eq(6).text(d.doc_tag);
            else
                $('#media_body dd').eq(6).text(" ");
            if (d.doc_file)
                $('#media_body dd').eq(7).find('a').attr('href', d.doc_file).text(d.doc_file.substr(d.doc_file.lastIndexOf('/')+1));
            else
                $('#media_body dd').eq(7).find('a').attr('href', ' ').text(' ');
        }
        
        $('#docadd-form').change(function(){
			var d = $('#docadd-form').serialize();
			var d={};  
            $($('#docadd-form').serializeArray()).each(function(){  
                d[this.name]=this.value;  
            });
            initEcard(d);
            
        });
        
        $("#docadd-form").validate({
			rules : {
				doc_name : {
					required : true
				},
				doc_type : {
				    required : true
				},
				total_num : {
				    required : true,
				    digits : true
				},
				doc_location : {
				    required : true,
				},
				doc_mgr : {
				    required : true,
				},
				project_name : {
					required : true
				}
			},

			submitHandler : function(form) {
			    $.ajax({
			        url:'/doc/save',
			        type:'POST',
			        data : $("#docadd-form").serialize(),
					success : function(data) {
					    $.bigBox({
							title : "提示信息",
							content : "保存档案信息成功！档案Id为"+data.doc_id,
							color : "#739E73",
							timeout : 6000,
							icon : "fa fa-check"
						}, function() {
							window.location.reload();
						});
					},
					error: function(data) {
					    $.bigBox({
	             			title : "错误信息",
	             			content : "保存档案信息失败！",
	             			color : "#C46A69",
	             			icon : "fa fa-warning shake animated",
	             			timeout : 6000
	             		});
					}
			    });
			    $('#submit-form').addClass('disabled');
			},

			errorPlacement : function(error, element) {
				error.insertAfter(element.parent());
			}
		});
        
        var previewNode = document.querySelector("#template");
        previewNode.id = "";
        var previewTemplate = previewNode.parentNode.innerHTML;
        previewNode.parentNode.removeChild(previewNode);
         
        var myDropzone = new Dropzone(previewNode,{ // Make the whole body a dropzone
          url: "/fileupload", // Set the url
          thumbnailWidth: 200,
          thumbnailHeight: 150,
          parallelUploads: 20,
          previewTemplate: previewTemplate,
          autoQueue: false, // Make sure the files aren't queued until manually added
          previewsContainer: "#previews", // Define the container to display the previews
          clickable: ".fileinput-button", // Define the element that should be used as click trigger to select files.
          maxFiles: 1,
          maxFilesize: 2,
          acceptedFiles: "image/*",
           dictFileTooBig: "上传文件 ({{filesize}}MiB)超过最大限制{{maxFilesize}}MiB.",
           dictInvalidFileType: "无法上传此类型文件！",
           dictResponseError: "Server responded with {{statusCode}} code.",
           dictCancelUpload: "取消上传！",
           dictCancelUploadConfirmation: "确定要中断上传？",
           dictMaxFilesExceeded: "无法上传更多的文件！",
        });
        
        myDropzone.on("maxfilesexceeded", function(file) {
            var preview = file.previewElement;
       		preview.parentNode.removeChild(preview);
  			myDropzone.removeFile(file);
        });
        
        myDropzone.on("addedfile", function(file) {
          file.previewElement.querySelector(".start").onclick = function() { myDropzone.enqueueFile(file); };
        });
         
        myDropzone.on("removedfile", function(file) {
            $("#doc_img").attr('value', '');
            $('#docadd-form').change();
        });
        
        myDropzone.on("sending", function(file) {
          file.previewElement.querySelector(".start").setAttribute("disabled", "disabled");
          $('#submit-form').addClass("disabled");
        });
        myDropzone.on("success", function(file, responseText) {
            if (responseText.msg) {
                $("#previews div strong").text(responseText.msg);
            }
            if (responseText.url) {
                $("#doc_img").attr('value', responseText.url);
                $('#docadd-form').change();
            }
         });
        
        myDropzone.on("queuecomplete", function(progress) {
            $('#submit-form').removeClass("disabled");
        });
        
        var previewNodedoc = document.querySelector("#doctemplate");
        previewNodedoc.id = "";
        var previewTemplatedoc = previewNodedoc.parentNode.innerHTML;
        previewNodedoc.parentNode.removeChild(previewNodedoc);
         
        var myDropzonedoc = new Dropzone(previewNodedoc,{ // Make the whole body a dropzone
          url: "/fileuploaddoc", // Set the url
          parallelUploads: 20,
          previewTemplate: previewTemplatedoc,
          autoQueue: false, // Make sure the files aren't queued until manually added
          previewsContainer: "#docpreviews", // Define the container to display the previews
          clickable: ".docfileinput-button", // Define the element that should be used as click trigger to select files.
          maxFiles: 1,
          maxFilesize: 2000,
           dictFileTooBig: "上传文件 ({{filesize}}MiB)超过最大限制{{maxFilesize}}MiB.",
           dictInvalidFileType: "无法上传此类型文件！",
           dictResponseError: "Server responded with {{statusCode}} code.",
           dictCancelUpload: "取消上传！",
           dictCancelUploadConfirmation: "确定要中断上传？",
           dictMaxFilesExceeded: "无法上传更多的文件！",
        });
        
        myDropzonedoc.on("maxfilesexceeded", function(file) {
            var preview = file.previewElement;
       		preview.parentNode.removeChild(preview);
       		myDropzonedoc.removeFile(file);
        });
        
        myDropzonedoc.on("addedfile", function(file) {
          file.previewElement.querySelector(".start").onclick = function() { myDropzonedoc.enqueueFile(file); };
        });
        myDropzonedoc.on("removedfile", function(file) {
            $("#doc_file").attr('value', '');
            $('#docadd-form').change();
        });
         
        myDropzonedoc.on("sending", function(file) {
          file.previewElement.querySelector(".start").setAttribute("disabled", "disabled");
          $('#submit-form').addClass("disabled");
        });
        myDropzonedoc.on("success", function(file, responseText) {
            if (responseText.msg)
                $("#docpreviews div strong").text(responseText.msg);
            if (responseText.url){
                $("#doc_file").attr('value', responseText.url);
                $('#docadd-form').change();
            }
            	
         });
        
        myDropzonedoc.on("queuecomplete", function(progress) {
            $('#submit-form').removeClass("disabled");
        });
         
    };
    
    loadScript("js/plugin/sparkline/jquery.sparkline.min.js", function(){
    	loadScript("js/plugin/datatables/jquery.dataTables.min.js", function(){
			loadScript("js/plugin/datatables/dataTables.colVis.min.js", function(){
				loadScript("js/plugin/datatables/dataTables.tableTools.min.js", function(){
				    loadScript("js/plugin/dropzone/dropzone.js", function(){
					loadScript("js/plugin/datatables/dataTables.bootstrap.min.js", pagefunction);
				    });
				});
			});
		});
    });
</script>
