<div class="row">
	<div class="col-xs-12 col-sm-12 col-md-12 col-lg-12">
		<h1 class="page-title txt-color-blueDark">
			<i class="fa fa-reply  fa-fw "></i> 借阅归还
		</h1>
	</div>
</div>

<!-- widget grid -->
<section id="widget-grid" class="">

	<!-- row -->
	<div class="row">

		<!-- NEW WIDGET START -->
		<article class="col-xs-12 col-sm-12 col-md-12 col-lg-12">

			<!-- Widget ID (each widget will need unique ID)-->
			<div class="jarviswidget" id="wid-id-2"
				data-widget-deletebutton="false" data-widget-editbutton="false">
				<!-- widget options:
					usage: <div class="jarviswidget" id="wid-id-0" data-widget-editbutton="false">
					
					data-widget-colorbutton="false"	
					data-widget-editbutton="false"
					data-widget-togglebutton="false"
					data-widget-deletebutton="false"
					data-widget-fullscreenbutton="false"
					data-widget-custombutton="false"
					data-widget-collapsed="true" 
					data-widget-sortable="false"
					
				-->
				<header>
					<span class="widget-icon"> <i class="fa fa-edit"></i>
					</span>
					<h2>查询</h2>

				</header>

				<!-- widget div-->
				<div>

					<!-- widget content -->
					<div class="widget-body">
						<form action="" class="smart-form">
							<fieldset>
							<div class="row">
									<section class="col col-4  col-sm-6">
										<label class="input"> 
											<i class="icon-prepend fa fa-barcode"></i>
											<input type="text"
												id="doc_id" placeholder="档案编号">
										</label>
									</section>
									<section class="col col-4  col-sm-6">
										<label class="input"> 
											<i class="icon-prepend fa fa-folder"></i>
											<input type="text"
												id="doc_name" placeholder="档案名称">
										</label>
									</section>
									<section class="col col-4  col-sm-6">
										<label class="input"> 
											<i class="icon-prepend fa fa-folder"></i>
											<input type="text"
												id="project_name" placeholder="项目名称">
										</label>
									</section>
									</div>
									<div class="row">
									<section class="col col-4  col-sm-6">
										<label class="select"> <select id="doc_type">
											<option value="">档案类型</option>
									    	</select> <i></i>
										</label>
									</section>
									
								<section class="col col-4 col-sm-6">
									<label class="select"> <select id=brower_men>
											<option value="">借阅归还人</option>
									    </select> <i></i>
									</label>
								</section>
								<section class="col col-4 col-sm-6">
									<label class="select"> <select id="doc_location">
											<option value="">档案位置</option>
									    </select> <i></i>
									</label>
								</section>
								</div>
								<div class="row">
									<section class="col col-4 col-sm-6">
										<label class="input">
											<input type="text"
												name="odc_tag" placeholder="主题词">
										</label>
									</section>
									<section class="col col-4 col-sm-6">
									<label class="select"> <select id=brower_mark>
											<option value="">借阅归还</option>
										  	<option value="借阅">借阅</option>
										  	<option value="归还">归还</option> 
									    </select> <i></i>
									</label>
								</section>
									<section class="col col-4 col-sm-6">
									<button id="submit" type="submit" class="btn btn-primary btn-sm"><i class="fa fa-search"></i>
										查询
									</button>
								</section>
								</div>
								</fieldset>
								
							
						</form>
					</div>
					<!-- end widget content -->

				</div>
				<!-- end widget div -->

			</div>
			<!-- end widget -->
			
			<!-- Widget ID (each widget will need unique ID)-->
			<div class="jarviswidget" id="wid-id-1" data-widget-editbutton="false" data-widget-deletebutton="false" >
				<!-- widget options:
				usage: <div class="jarviswidget" id="wid-id-0" data-widget-editbutton="false">

				data-widget-colorbutton="false"
				data-widget-editbutton="false"
				data-widget-togglebutton="false"
				data-widget-deletebutton="false"
				data-widget-fullscreenbutton="false"
				data-widget-custombutton="false"
				data-widget-collapsed="true"
				data-widget-sortable="false"

				-->
				<header>
					<span class="widget-icon"> <i class="fa fa-table"></i> </span>
					<h2>数据</h2>

				</header>

				<!-- widget div-->
				<div>

					<!-- widget content -->
					<div class="widget-body no-padding">
						<h1 id="loading" class="ajax-loading-animation text-center"><i class="fa fa-cog fa-spin"></i> Loading...</h1>
						<table id="datatable_col_reorder" class="table table-striped table-condensed " cellspacing="0" width="100%">
							<thead>
								<tr> 
									<th>档案编号</th>
									<th>档案名称</th>
									<th>档案位置</th>
									<th>借阅归还人</th>
									<th>存档数</th>
									<th>借阅归还</th>
									<th>时间</th>
									<th>是否归还</th>
									<th>操作</th>
								</tr>
							</thead>
						</table>

					</div>
					<!-- end widget content -->

				</div>
				<!-- end widget div -->

			</div>
			<!-- end widget -->

		</article>
		<!-- WIDGET END -->

	</div>
	<!-- end row -->
</section>
<div id="action" class="hidden">
<div class="btn-group">
	<button class="btn btn-primary btn-xs dropdown-toggle" data-toggle="dropdown">
		&nbsp;操作&nbsp; <span class="caret"></span>
	</button>
	<ul class="dropdown-menu">
		<li>
			<a action="brower">借阅</a>
		</li>
		<li>
			<a action="back">归还</a>
		</li>
	</ul>
</div>
</div>
<!-- Dynamic Modal -->  
<div class="modal fade" id="browerMoal" tabindex="-2" role="dialog" aria-labelledby="remoteModalLabel" aria-hidden="true">  
    <div class="modal-dialog">  
        <div class="modal-content">
        	<!-- content will be filled here from "ajax/modal-content/model-content-1.html" -->
        </div>  
    </div>  
</div>

<script type="text/javascript">
    pageSetUp();
    
    
    var pagefunction = function() {
        initDict('档案类型', $('#doc_type'));
        initDict('档案位置', $('#doc_location'));
        initUser( $('#brower_men'));
        var dt = $('#datatable_col_reorder').DataTable({
            "iDisplayLength":20,
            "bPaginate": true,
            "bFilter": false,
            "bSort": false, //排序功能
            "bLengthChange":false,
            "bInfo": false,
            "deferRender": true,
            "renderer": "bootstrap",
            "processing": false,
            "serverSide": true,
            "bDestroy": true,
            "ajax": {
                "url": "/brower/all",
                "type": "POST",
                "data": function ( d ) {
                    return $.extend( {}, d, {
                        "doc_id": $('#doc_id').val(),
                        "doc_name": $('#doc_name').val(),
                        "project_name": $('#project_name').val(),
                        "doc_type": $('#doc_type').val(),
                        "brower_men": $('#brower_men').val(),
                        "doc_location": $('#doc_location').val(),
                        "doc_tag": $('#doc_tag').val(),
                        "brower_mark": $('#brower_mark').val(),
                      } );
                 },
                 "error": function(request) {
                     $.bigBox({
             			title : "错误",
             			content : "查询借阅归还信息出错，请联系系统管理员！",
             			color : "#C46A69",
             			icon : "fa fa-warning shake animated",
             			timeout : 6000
             		});
                 },
                 "complete": function() {
                     $("#loading").hide();
                     $("#datatable_col_reorder_wrapper").fadeIn(500);
                 },
                 "beforeSend": function() {
                     $("#loading").show();
                     $("#datatable_col_reorder_wrapper").hide();
                 }
            },
			"oLanguage": {
			    "sZeroRecords": "没有检索到数据",
			    "oPaginate": {
			    "sPrevious": "上一页",
			    "sNext": "下一页",
			    },
			  "sZeroRecords": "没有检索到数据",
			},
			"columns": [
	            { "data": "doc_id" },
	            { "data": "doc_name" },
	            { "data": "doc_location" },
	            { "data": "brower_men" },
	            { "data": "store_num" },
	            { "data": "brower_mark" },
	            { "data": "brower_time" },
	            { "data": "is_back" },
	            { "data": "_id" }
	            
			],
		  	"columnDefs": [ {
	                "targets": [2, 3, 4, 5, 6],
	                "sortable": false,
	                "defaultContent": ""
		  	  } , {
	                "targets": 7,
	                "render": function ( data, type, full, meta ) {
	                    var msg = '';
	                    if (full.brower_mark == '借阅') {
	                    	if (full.is_back)
		                        msg = '已归还';
	                    	else
	                    	    msg = '未归还';
	                    }
						return msg;
					}
		  	  } , {
	                "targets": 8,
	                "render": function ( data, type, full, meta ) {
						var action = $('#action');
						return action.html();
					}
		  	  } ],
		  	 "fnDrawCallback": function (oSettings) {
		  	   bindClick();
           	  } 
        });
        
      	//定义查询按钮
        $("#submit").on('click', function(){
            dt.ajax.reload();
        });
      	
        $("#datatable_col_reorder_wrapper").addClass("table-responsive");
       
         
        function bindClick() {
            $('a[action=brower]').click(function(event) {
                event = event ? event : window.event;
                var e = event.srcElement ? event.srcElement : event.target; 
                var tr = $(e).closest('tr');
                var doc_id = tr.children('td').eq(0).text();
                //检查库存量
                var store_num = tr.children('td').eq(4).text();
                if (store_num > 0) {
                    $('#browerMoal').modal({
                        keyboard: false,
                        remote: "ajax/brower2.html",
                    });
                    $('#browerMoal').on('shown.bs.modal', function (e) {
                        $('#brower-form-1').find('#brower_doc_id').val(doc_id);
                        $('#brower-form-1').find('#brower_mark').val('借阅');
                        $('#browerMoal').data.result = undefined;
                     });
                    
                    $('#browerMoal').on('hidden.bs.modal', function (e) {
				    	if($('#browerMoal').data.result) {
				    	    dt.ajax.reload();
				    	}
                     });
                } else {
                    event.preventDefault();
                    event.stopPropagation();
                    $.bigBox({
        				title : "警告",
        				content : "库存量不足无法借阅！",
        				color : "#C79121",
        				timeout: 6000,
        				icon : "fa fa-warning shake animated",
        			});
                }
            });
            
            $('a[action=back]').click(function(event) {
                event = event ? event : window.event;
                var e = event.srcElement ? event.srcElement : event.target; 
                var tr = $(e).closest('tr');
                var doc_id = tr.children('td').eq(0).text();
                //检查库存量
                var row = dt.row(tr).data();
                var store_num = row.store_num;
                var total_num = row.total_num;
                if (store_num != total_num) {
                    $('#browerMoal').modal({
                        keyboard: false,
                        remote: "ajax/brower2.html"
                    });
                    $('#browerMoal').on('hidden.bs.modal', function (e) {
				    	if($('#brower-form-1').data.result) {
				    	    dt.ajax.reload();
				    	}
                     });
                     
                    $('#browerMoal').on('shown.bs.modal', function (e) {
                        $('#brower-form-1').find('#brower_doc_id').val(doc_id);
                        $('#brower-form-1').find('#brower_mark').val('归还');
                        $('#brower-form-1').data.result = undefined;
                     });
                } else {
                    event.preventDefault();
                    event.stopPropagation();
                    $.bigBox({
        				title : "警告",
        				content : "档案无借阅记录，归还失败！",
        				color : "#C79121",
        				timeout: 6000,
        				icon : "fa fa-warning shake animated",
        			});
                }
            });
        }
        
    };
    
    
    
    loadScript("js/plugin/sparkline/jquery.sparkline.min.js", function(){
    	loadScript("js/plugin/datatables/jquery.dataTables.min.js", function(){
			loadScript("js/plugin/datatables/dataTables.colVis.min.js", function(){
				loadScript("js/plugin/datatables/dataTables.tableTools.min.js", function(){
					loadScript("js/plugin/datatables/dataTables.bootstrap.min.js", pagefunction);
				});
			});
		});
    });
</script>
